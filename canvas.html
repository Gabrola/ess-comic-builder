<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>ESS Comic Maker</title>
	<link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-responsive.css" rel="stylesheet">
    <link href="css/jquery-ui-1.8.16.custom.css" rel="stylesheet">
	<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/bootstrap-tooltip.js"></script>
	<script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
    <script type="text/javascript" src="js/kinetic-v3.9.4.js"></script>
	<style>
		html, body { margin: 0px; padding: 0px; }
		canvas { border: 1px solid #000; }
		#rages { width: 250px; height: 700px; overflow: scroll; float: left;  }
		.rage { margin: 20px; z-index: 100; }
		td { padding: 20px; }
    </style>
    <script>
	var stage = "";
	var EditMode = true;
	var LastGroup = "";
	
	function toggleDisplay(name, visibility) { 
		var shapes = stage.get(name);
		for(var n = 0; n < shapes.length; n++) {
			var shape = shapes[n];
			if (!visibility) {
				shape.show()
			} else {
				shape.hide();
			}
		}
	}
	function update(group, activeAnchor) {
        var topLeft = group.get(".topLeft")[0];
        var topRight = group.get(".topRight")[0];
        var bottomRight = group.get(".bottomRight")[0];
        var bottomLeft = group.get(".bottomLeft")[0];
        var image = group.get(".image")[0];
		
        switch (activeAnchor.getName()) {
          case "topLeft":
            topRight.attrs.y = activeAnchor.attrs.y;
            bottomLeft.attrs.x = activeAnchor.attrs.x;
            break;
          case "topRight":
            topLeft.attrs.y = activeAnchor.attrs.y;
            bottomRight.attrs.x = activeAnchor.attrs.x;
            break;
          case "bottomRight":
            bottomLeft.attrs.y = activeAnchor.attrs.y;
            topRight.attrs.x = activeAnchor.attrs.x;
            break;
          case "bottomLeft":
            bottomRight.attrs.y = activeAnchor.attrs.y;
            topLeft.attrs.x = activeAnchor.attrs.x;
            break;
        }

        image.setPosition(topLeft.attrs.x, topLeft.attrs.y);
        image.setSize(topRight.attrs.x - topLeft.attrs.x, bottomLeft.attrs.y - topLeft.attrs.y);
      }
	function addAnchor(group, x, y, name) {
        stage = group.getStage();
        var layer = group.getLayer();

        var anchor = new Kinetic.Circle({
          x: x,
          y: y,
          stroke: "#666",
          fill: "#ddd",
          strokeWidth: 1,
          radius: 5,
          name: name,
          draggable: true,
		  visible: EditMode
        });

        anchor.on("dragmove", function() {
          update(group, this);
          layer.draw();
        });
        anchor.on("mousedown touchstart", function() {
          group.draggable(false);
          this.moveToTop();
        });
        anchor.on("dragend", function() {
          group.draggable(true);
          layer.draw();
        });
        anchor.on("mouseover", function() {
          var layer = this.getLayer();
          document.body.style.cursor = "pointer";
          this.setStrokeWidth(2);
          layer.draw();
        });
        anchor.on("mouseout", function() {
          var layer = this.getLayer();
          document.body.style.cursor = "default";
          this.setStrokeWidth(1);
          layer.draw();
        });

        group.add(anchor);
      }
	  
	function ClearCanvas()
	{
		stage.removeChildren();
		stage.clear();
		var layer = new Kinetic.Layer();
		
		var line1Points = [
			{ x: 250, y: 0 },
			{ x: 250, y: 500 }];

		var line2Points = [
			{ x: 0, 	y: 250 },
			{ x: 500,	y: 250 }];

		var line1 = new Kinetic.Line({
			points: line1Points,
			stroke: "black",
			strokeWidth: 2,
			lineCap: 'square'
		});
		var line2 = new Kinetic.Line({
			points: line2Points,
			stroke: "black",
			strokeWidth: 2,
			lineCap: 'square'
		});
		var Background = new Kinetic.Rect({
			x: 0,
			y: 0,
			width: 500,
			height: 500,
			fill: "#FFFFFF",
		});
		layer.add(Background);
		layer.add(line1);
		layer.add(line2);
		Background.moveToBottom();
		stage.add(layer);
	}
	  
	 function InitStage()
	 {
		$(".rage").draggable({ helper: 'clone' });
		stage = new Kinetic.Stage({
			container: "container",
			width: 500,
			height: 500
		});
		
		ClearCanvas();

		$("#drawCanvasContainer").droppable({
			accept: '.rage',
			drop: function(event, ui) {
				var imgObj = new Image();
				imgObj.onload = function() {
					var ImageWidth = imgObj.width;
					var ImageHeight = imgObj.height;
					
					var imgGroup = new Kinetic.Group({
						x: (ui.position.left - $("#container").offset().left) + (ImageWidth / 2),
						y: (ui.position.top - $("#container").offset().top) + (ImageHeight / 2),
						draggable: true
					});
					
					LastGroup = imgGroup;
					$( "#slider" ).slider('value', LastGroup.getRotationDeg());
					
					imgGroup.on("mousedown", function() {
						LastGroup = imgGroup;
						$( "#slider" ).slider('value', LastGroup.getRotationDeg());
					});
					
					var layer = new Kinetic.Layer();
					layer.add(imgGroup);
					stage.add(layer);
					
					var image = new Kinetic.Image({
						x: 0,
						y: 0,
						image: imgObj,
						name: "image",
						src: 'images/' + ui.draggable.attr("id") + '.png'
					});
					
					imgGroup.setCenterOffset(ImageWidth / 2, ImageHeight / 2);
					imgGroup.add(image);
					addAnchor(imgGroup, 0, 0, "topLeft");
					addAnchor(imgGroup, ImageWidth, 0, "topRight");
					addAnchor(imgGroup, ImageWidth, ImageHeight, "bottomRight");
					addAnchor(imgGroup, 0, ImageHeight, "bottomLeft");
					imgGroup.on("dragstart", function() { this.moveToTop(); });
					stage.draw();
				};
				imgObj.src = 'images/' + ui.draggable.attr("id") + '.png';
			}
		});
	 }
	  
	window.onload = function() {
	
		InitStage();
		
		var PreloadImages = [
		"lol1","asa7be","rage1","rage2","rage3","rage4","rage5","rage6","rage7","rage8","rage9","rage10",
		"rage11", "rage12", "rage13", "rage14", "cereal1"];
		
		for(var i = 0; i < PreloadImages.length; i++)
		{
			var Preload = new Image();
			Preload.src = 'images/' + PreloadImages[i] + '.png';
		}
	
		$("#previewButton").click(function() {
			if(EditMode == false)
				$("#previewButton").html("Preview");
			else
				$("#previewButton").html("Edit");
				
			toggleDisplay(".topLeft", EditMode);
			toggleDisplay(".topRight", EditMode);
			toggleDisplay(".bottomRight", EditMode);
			toggleDisplay(".bottomLeft", EditMode);
			
			EditMode = !EditMode;
				
			stage.draw();
		});
		
		$( "#slider" ).slider({
			orientation: "vertical",
			value:0,
			min: 0,
			max: 360,
			step: 1,
			slide: function( event, ui ) {
				LastGroup.setRotationDeg(ui.value);
				stage.draw();
			}
		});
		
		$("[rel=tooltip]").tooltip();
		
		$("#clearButton").click(function() {
			ClearCanvas();
			stage.draw();
		});
	
		$("#downloadJSON").click(function() {
			$.download('download.ajax.php','json=' + encodeURIComponent(stage.toJSON()) );
		});
	
		$("#downloadImg").click(function() {
			toggleDisplay(".topLeft", true);
			toggleDisplay(".topRight", true);
			toggleDisplay(".bottomRight", true);
			toggleDisplay(".bottomLeft", true);
			
			EditMode = false;
			
			stage.draw();
			stage.toDataURL(function(dataUrl) {
				$.download('download.ajax.php','imgdata=' + encodeURIComponent(dataUrl) + '&imgname=image.png');
				layer.remove(Background);
				stage.draw();
			}, "image/png");
		});
	
		$("#loadJson").click(function() {
			stage.load($("#json").html());
			SetEvents(stage);
		});
		
		document.getElementById('files').addEventListener('change', handleFileSelect, false);
	};
	
	jQuery.download = function(url, data, method){
		if( url && data ){ 
			data = typeof data == 'string' ? data : jQuery.param(data);
			var inputs = '';
			jQuery.each(data.split('&'), function(){ 
				var pair = this.split('=');
				inputs+='<input type="hidden" name="'+ pair[0] +'" value="'+ pair[1] +'" />'; 
			});
			jQuery('<form action="'+ url +'" method="'+ (method||'post') +'">'+inputs+'</form>')
			.appendTo('body').submit().remove();
		};
	};
	
	function SetEvents(Parent)
	{
		var children = Parent.getChildren();
		for(var n = 0; n < children.length; n++) {
			var child = children[n];
			if(child.nodeType !== 'Shape')
			{
				SetEvents(child);
				if(child.nodeType == 'Group')
				{
					child.on("mousedown", function() {
						LastGroup = child;
						$( "#slider" ).slider('value', LastGroup.getRotationDeg());
					});
				}
			}
			else
			{
				if(child.shapeType == 'Circle')
				{
					EditMode = child.isVisible();
						
					if(EditMode == true)
						$("#previewButton").html("Preview");
					else
						$("#previewButton").html("Edit");
						
					var layer = child.getLayer();
					child.on("dragmove", function() {
					  update(Parent, this);
					  layer.draw();
					});
					child.on("mousedown touchstart", function() {
					  Parent.draggable(false);
					  this.moveToTop();
					});
					child.on("dragend", function() {
					  Parent.draggable(true);
					  layer.draw();
					});
					child.on("mouseover", function() {
					  var layer = this.getLayer();
					  document.body.style.cursor = "pointer";
					  this.setStrokeWidth(2);
					  layer.draw();
					});
					child.on("mouseout", function() {
					  var layer = this.getLayer();
					  document.body.style.cursor = "default";
					  this.setStrokeWidth(1);
					  layer.draw();
					});
				}
			}
		}
	}
	
	function handleFileSelect(evt) {
    var files = evt.target.files;
    for (var i = 0, f; f = files[i]; i++) {
      var reader = new FileReader();
      reader.onload = (function(theFile) {
        return function(e) {
			alert('lol');
		  stage.load(e.target.result);
			SetEvents(stage);
        };
      })(f);
      reader.readAsText(f);
    }
  }
</script>
</head>
<body>
	<table style="height: 100%;" cellspacing="50">
		<tr>
			<td rowspan="2">
				<div id="rages">
					<img class="rage" width="150" id="lol1" src="images/lol1.png" />
					<img class="rage" width="150" id="asa7be" src="images/asa7be.png" />
					<img class="rage" width="150" id="rage1" src="images/rage1.png" />
					<img class="rage" width="150" id="rage2" src="images/rage2.png" />
					<img class="rage" width="150" id="rage3" src="images/rage3.png" />
					<img class="rage" width="150" id="rage4" src="images/rage4.png" />
					<img class="rage" width="150" id="rage5" src="images/rage5.png" />
					<img class="rage" width="150" id="rage6" src="images/rage6.png" />
					<img class="rage" width="150" id="rage7" src="images/rage7.png" />
					<img class="rage" width="150" id="rage8" src="images/rage8.png" />
					<img class="rage" width="150" id="rage9" src="images/rage9.png" />
					<img class="rage" width="150" id="rage10" src="images/rage10.png" />
					<img class="rage" width="150" id="rage11" src="images/rage11.png" />
					<img class="rage" width="150" id="rage12" src="images/rage12.png" />
					<img class="rage" width="150" id="rage13" src="images/rage13.png" />
					<img class="rage" width="150" id="rage14" src="images/rage14.png" />
					<img class="rage" width="150" id="cereal1" src="images/cereal1.png" />
				</div>
			</td>
			<td>
				<div id="drawCanvasContainer">
					<div id="container"></div>
				</div>
			</td>
			<td>
				<div id="slider" rel="tooltip" title="Rotate Image"></div>
			</td>
		</tr>
		<tr>
			<td colspan="2">
				<div class="btn-group" style="display: inline-block; ">
					<button class="btn btn-primary" id="clearButton">Clear</button>
					<button class="btn btn-primary" id="previewButton">Preview</button>
					<button class="btn btn-primary" id="downloadJSON">Download JSON</button>
					<button class="btn btn-primary" id="downloadImg">Download Image</button>
				</div>
				<label class="control-label" for="files">Load From JSON: </label><input type="file" id="files" name="files" class=""  />
			</td>
		</tr>
	</table>
</body>
</html>
