<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>ESS Comic Maker</title>
	<link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-responsive.css" rel="stylesheet">
    <link href="css/jquery-ui-1.8.16.custom.css" rel="stylesheet">
	<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/bootstrap-tooltip.js"></script>
	<script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
    <script type="text/javascript" src="js/fabric.js"></script>
	<style>
		html, body { margin: 0px; padding: 0px; }
		canvas { border: 1px solid #000; }
		#rages { width: 250px; height: 700px; overflow: scroll; float: left;  }
		.rage { margin: 20px; z-index: 100; }
		td { padding: 20px; }
    </style>
<script>
var canvas = "";

window.onload = function() {
	canvas = new fabric.Canvas('c', {backgroundColor: '#FFFFFF'});

	LoadCanvas();

	var PreloadImages = [
	"lol1","asa7be","rage1","rage2","rage3","rage4","rage5","rage6","rage7","rage8","rage9","rage10",
	"rage11", "rage12", "rage13", "rage14", "cereal1"];

	for(var i = 0; i < PreloadImages.length; i++)
	{
		var Preload = new Image();
		Preload.src = 'images/' + PreloadImages[i] + '.png';
		Preload.dragWidth = Preload.width;
		Preload.dragHeight = Preload.height;
		Preload.width = 70;
		Preload.height = 70;
		$(Preload).addClass('rage').attr('id', PreloadImages[i])
		$("#rages").append(Preload);
	}

	$(".rage").draggable({ helper: 'clone',
		start: function(e, ui){
			$(ui.helper).css({ width: this.dragWidth, height: this.dragHeight });
		}
	});

	$("#drawCanvasContainer").droppable({
		accept: '.rage',
		drop: function(event, ui) {
			var src = ui.draggable.attr("id");
			var oImg;
			fabric.Image.fromURL('images/' + src + '.png', function(img) {
				oImg = img.set({ left: ui.position.left - $("#c").offset().left + (img.width / 2), top: ui.position.top - $("#c").offset().top + (img.height / 2) })
				canvas.add(oImg);
				canvas.renderAll();
				console.log(JSON.stringify(canvas.toDatalessJSON()));
			});
		}
	});

	$("#clearButton").click(function() {
		canvas.clear();
		LoadCanvas();
	});

	$("#downloadJSON").click(function() {
		$.download('download.ajax.php','json=' + encodeURIComponent(JSON.stringify(canvas.toJSON())) );
	});

	$("#downloadImg").click(function() {
		$.download('download.ajax.php','imgdata=' + encodeURIComponent(canvas.toDataURL('png')) + '&imgname=image.png');
	});

	document.getElementById('files').addEventListener('change', handleFileSelect, false);
};

function LoadCanvas()
{
	var line1 = new fabric.Line([ 0, 250, 500, 250 ], {
		fill: 'black',
		strokeWidth: 1,
		selectable: false
	});
	var line2 = new fabric.Line([ 250, 0, 250, 500 ], {
		fill: 'black',
		strokeWidth: 1,
		selectable: false
	});

	canvas.add(line1);
	canvas.add(line2);
	canvas.renderAll();
}
	
jQuery.download = function(url, data, method){
	if( url && data ){ 
		data = typeof data == 'string' ? data : jQuery.param(data);
		var inputs = '';
		jQuery.each(data.split('&'), function(){ 
			var pair = this.split('=');
			inputs+='<input type="hidden" name="'+ pair[0] +'" value="'+ pair[1] +'" />'; 
		});
		jQuery('<form action="'+ url +'" method="'+ (method||'post') +'">'+inputs+'</form>')
		.appendTo('body').submit().remove();
	};
};

function handleFileSelect(evt) {
	var files = evt.target.files;
	for (var i = 0, f; f = files[i]; i++) {
		var reader = new FileReader();
		reader.onload = (function(theFile) {
			return function(e) {
			canvas.loadFromJSON(e.target.result);
			};
		})(f);
		reader.readAsText(f);
	}
}
</script>
</head>
<body>
	<table style="height: 100%;" cellspacing="50">
		<tr>
			<td rowspan="2">
				<div id="rages"></div>
			</td>
			<td>
				<div id="drawCanvasContainer">
					<canvas id="c" width="500" height="500"></canvas>
				</div>
			</td>
		</tr>
		<tr>
			<td>
				<div class="btn-group" style="display: inline-block; ">
					<button class="btn btn-primary" id="clearButton">Clear</button>
					<button class="btn btn-primary" id="downloadJSON">Download JSON</button>
					<button class="btn btn-primary" id="downloadImg">Download Image</button>
				</div>
				<label class="control-label" for="files">Load From JSON: </label><input type="file" id="files" name="files" class=""  />
			</td>
		</tr>
	</table>
</body>
</html>
